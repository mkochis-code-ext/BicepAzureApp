# ------------------------------------------------------------------------------------------------------------------------
# IMPORTANT: To enable this workflow, move this file to the .github/workflows directory (e.g. .github/workflows/main.yml)
# ------------------------------------------------------------------------------------------------------------------------

name: Deploy Bicep to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'environments/dev/**'
      - 'project/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Log in to Azure using Service Principal Secret
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Deploy the Bicep template
      # Using 'az deployment sub create' because targetScope is 'subscription' in environments/dev/main.bicep
      - name: Deploy Bicep
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment sub create \
              --name "deploy-${{ github.run_id }}" \
              --location "canadacentral" \
              --template-file ./environments/dev/main.bicep \
              --parameters ./environments/dev/parameters.bicepparam

# ------------------------------------------------------------------------------------------------------------------------
# REQUIRED REPOSITORY SECRETS:
# ------------------------------------------------------------------------------------------------------------------------
# You need to add the following secret to your GitHub Repository (Settings -> Secrets and variables -> Actions):
#
# 1. AZURE_CREDENTIALS:
#    Run the following command in Azure CLI to generate the credential JSON:
#
#    az ad sp create-for-rbac --name "myAppGitHubActions" --role contributor --scopes /subscriptions/<SUBSCRIPTION-ID> --sdk-auth
#
#    Copy the entire JSON output and paste it as the value for the AZURE_CREDENTIALS secret.
#
#    Example JSON:
#    {
#      "clientId": "<GUID>",
#      "clientSecret": "<STRING>",
#      "subscriptionId": "<GUID>",
#      "tenantId": "<GUID>",
#      "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
#      "resourceManagerEndpointUrl": "https://management.azure.com/",
#      "activeDirectoryGraphResourceId": "https://graph.windows.net/",
#      "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
#      "galleryEndpointUrl": "https://gallery.azure.com/",
#      "managementEndpointUrl": "https://management.core.windows.net/"
#    }
# ------------------------------------------------------------------------------------------------------------------------
